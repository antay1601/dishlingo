# Описание работы Telegram-бота Dishlingo

Этот документ описывает актуальный цикл работы Telegram-бота, который преобразует фотографию меню в интерактивную HTML-страницу.

## Общий процесс

Процесс построен на использовании мультимодальной модели Google Gemini для выполнения нескольких задач в рамках одного запроса, что делает его эффективным и быстрым.

1.  **Получение изображения:** Пользователь отправляет фото меню. `handlers.py` принимает его, скачивает во временную папку и подготавливает к обработке.

2.  **Комплексная обработка меню (1 AI-запрос):** `ocr.py` отправляет изображение **одним запросом** в мультимодальную модель `gemini-1.5-flash-latest`. Модель выполняет сразу несколько задач:
    *   Распознает весь текст (OCR).
    *   Находит и структурирует блюда.
    *   Переводит названия на русский язык.
    *   Генерирует краткие аппетитные описания.
    *   Определяет категорию, цену и возможные ингредиенты.
    *   Возвращает единый JSON-объект со всем меню и флагом `isPartial`, если часть меню была нечитаема.

3.  **Поиск изображений (N запросов к Pexels API):** `image_fetcher.py` получает список блюд. Для каждого блюда он:
    *   Формирует поисковый запрос на основе оригинального или переведенного названия.
    *   Асинхронно обращается к API сервиса **Pexels**.
    *   Получает и добавляет в данные о блюде URL наиболее подходящего изображения.

4.  **Генерация HTML-страницы:** `html_generator.py` принимает финальный список блюд (уже с URL-ами картинок) и формирует готовую адаптивную HTML-страницу с карточками блюд, их описаниями, ценами и изображениями.

5.  **Отправка результата:** `handlers.py` отправляет пользователю сгенерированный HTML-файл.

## Количество запросов к внешним сервисам

Общее количество запросов для обработки одного меню рассчитывается по формуле:

**`1 (мультимодальный запрос к Gemini) + N (запросов к Pexels API для поиска картинок)`**

Где **N** — количество блюд, распознанных в меню.

Эта архитектура является очень эффективной, так как самый сложный этап анализа изображения и текста выполняется за один вызов AI.

### Пример объекта блюда (после шага 2)

После анализа изображения модель возвращает объект, содержащий массив блюд. Вот как выглядит один элемент этого массива (до поиска изображения):

```json
{
  "originalName": "Spaghetti Carbonara",
  "translatedName": "Спагетти Карбонара",
  "image": "placeholder",
  "category": "основное блюдо",
  "price": "14.50€",
  "shortDescription": "Классическая паста с беконом в сливочном соусе.",
  "ingredients": ["спагетти", "бекон", "яйцо", "сыр"],
  "containsGluten": "yes",
  "containsMilk": "yes"
}
```